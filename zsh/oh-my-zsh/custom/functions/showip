#!/usr/bin/env zsh
# Show IP address

local function __showip_usage() {
  (>&2 print \
"Usage:
  showip [options] [<iface>]

List interfaces with their IPv4 address, if none is specified list only the
ones that are assigned an IPv4 address.

If a interface with no address is specified then the string 'no address' is
printed.

Options:
  -h, --help             Show this help and exits.

Example:
  showip eth0")
}

local function __showip() {

  local opt

  while getopts ":h" opt; do
    case $opt in
      h)
        __showip_usage
        return 0
        ;;
      *)
        (>&2 echo "Flag $opt not recognized." )
        ;;
    esac
  done

  # does the work, select the IP and apply the regex above
  if [ $# -lt 1 ] ; then
    ip -o addr show | sed -re 's#[0-9]+:\s+(.+)\s+inet(6)?#\1#g' | \
      sed -re 's#(([0-9]{1,3}[\.]){3}[0-9]{1,3}(/[0-9]{1,2})?|(.{0,4}:?){8}(/[0-9]{1,3})).+#\1#g' | \
      column -t

  else
    local iface
    local res
    for iface in "$@"; do
      res=''
      res=$(ip -o addr show "$iface" | sed -re 's#[0-9]+:\s+(.+)\s+inet(6)?#\1#g' | \
            sed -re 's#(([0-9]{1,3}[\.]){3}[0-9]{1,3}(/[0-9]{1,2})?|(.{0,4}:?){8}(/[0-9]{1,3})).+#\1#g' | \
            column -t)
      if [ -z "$res" ]; then
        echo -e "${iface}"'\tno address'
      else
        echo "$res"
      fi
    done
  fi

}

__showip "$@"